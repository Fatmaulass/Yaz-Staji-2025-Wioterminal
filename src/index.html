<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Basit Blockchain Cüzdanı</title>
</head>

<body>
  <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 500px; margin: 20px auto;">
    <!-- Giriş Kartı -->
    <div
      style="background-color: #f8f1e5; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
      <h2 style="text-align: center; color: #5d4037; margin-bottom: 20px;">Giriş Yap</h2>
      <div style="display: flex; gap: 10px;">
        <input id="privateKeyInput" type="text" placeholder="Private Key Girin"
          style="flex: 1; padding: 10px; border: 1px solid #d7ccc8; border-radius: 5px; font-size: 14px;" />
        <button onclick="girisYap()"
          style="padding: 10px 20px; background-color: #8d6e63; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
          Giriş Yap
        </button>
      </div>
    </div>

    <!-- Cüzdan Kartı -->
    <div id="wallet"
      style="display:none; background-color: #d7ccc8; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
      <h2 style="color: #5d4037; margin-top: 0;">Cüzdan Bilgileri</h2>
      <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="margin: 5px 0; color: #5d4037;"><strong>Public Adresiniz:</strong></p>
        <p id="publicKey"
          style="word-break: break-all; background: #f5f5f5; padding: 8px; border-radius: 4px; font-size: 12px; margin: 5px 0 0 0;">
        </p>
      </div>
      <p style="margin: 0; font-size: 18px;"><strong>Bakiye:</strong> <span id="balance"
          style="font-weight: bold; color: #2e7d32;">0</span></p>
    </div>

    <!-- Para Gönderme Kartı -->
    <div id="paraGonder"
      style="display:none; background-color: #e8f5e9; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
      <h3 style="color: #2e7d32; text-align: center; margin-top: 0;">Para Gönder</h3>
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <input id="aliciAdres" type="text" placeholder="Alıcı Adresi"
          style="padding: 10px; border: 1px solid #c8e6c9; border-radius: 5px; font-size: 14px;" />
        <input id="miktar" type="number" placeholder="Miktar"
          style="padding: 10px; border: 1px solid #c8e6c9; border-radius: 5px; font-size: 14px;" />
        <button onclick="paraGonder()"
          style="padding: 12px; background-color: #2e7d32; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px;">
          Gönder
        </button>
      </div>
      <p id="sonuc" style="margin: 15px 0 0 0; text-align: center; font-weight: bold;"></p>
    </div>
    <div id="mempoolKarti"
      style="display:none; background-color: #fff3e0; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 20px;">
      <h3 style="color: #ef6c00; text-align: center; margin-top: 0;">Bekleyen İşlemler Havuzu (Mempool)</h3>
      <div id="mempoolListesi" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
  <script>
    const ec = new elliptic.ec('secp256k1');
    let privateKey = '';
    let publicKey = '';

    const socket = new WebSocket('ws://localhost:3000');
    socket.onopen = function (event) {
      console.log("Sunucu ile WebSocket bağlantısı kuruldu.");
    };

    // Sunucudan bir mesaj geldiğinde bu fonksiyon çalışır
    socket.onmessage = function (event) {
      const mesaj = JSON.parse(event.data);
      console.log("Sunucudan anlık bildirim:", mesaj);

      // Gelen mesajın türüne göre ilgili fonksiyonları tetikle
      if (mesaj.type === 'MEMPOOL_GUNCELLENDI' || mesaj.type === 'BLOK_KAZILDI') {
        if (publicKey) { // Sadece kullanıcı giriş yapmışsa yenile
          bakiyeGetir();    
          bekleyenIslemleriGuncelle();
        }
      }
    };

    socket.onclose = function (event) {
      console.log("WebSocket bağlantısı koptu. Sayfayı yenileyin.");
      alert("Sunucu ile anlık bağlantı koptu!");
    };


    function girisYap() {
      privateKey = document.getElementById("privateKeyInput").value.trim();
      if (!privateKey) {
        alert("Lütfen bir private key girin!");
        return;
      }
      try {
        const key = ec.keyFromPrivate(privateKey);
        publicKey = key.getPublic('hex').toLowerCase();

        fetch(`http://localhost:3000/api/kullanici-dogrula?publicKey=${publicKey}`)
          .then(res => {
            if (!res.ok) throw new Error('Geçersiz private key!');
            return res.json();
          })
          .then(data => {
            document.getElementById("wallet").style.display = "block";
            document.getElementById("paraGonder").style.display = "block";
            document.getElementById("publicKey").textContent = publicKey;
            document.getElementById("mempoolKarti").style.display = "block";
            bakiyeGetir();
            bekleyenIslemleriGuncelle();
          })
          .catch(err => alert(err.message));
      } catch (err) {
        alert("Girilen private key formatı hatalı! ");
      }
    }
    function bakiyeGetir() {
      fetch(`http://localhost:3000/api/bakiye?adres=${publicKey}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("balance").textContent = data.bakiye ?? 0;
        });
    }
    function paraGonder() {
      const aliciAdresInput = document.getElementById("aliciAdres");
      const miktarInput = document.getElementById("miktar");
      const sonucMesaji = document.getElementById("sonuc");

      const aliciAdres = aliciAdresInput.value.trim();
      const miktar = parseFloat(miktarInput.value);

      if (!aliciAdres || !miktar || miktar <= 0) {
        alert("Geçerli bir alıcı adresi ve miktar girin.");
        return;
      }
      if (aliciAdres === publicKey) {
        alert("Kendinize para gönderemezsiniz.");
        return;
      }

      const islemVerisi = {
        gonderenAdres: publicKey,
        aliciAdres: aliciAdres,
        miktar: miktar,
        ucret: 0,
        zamanDamgasi: Date.now().toString()
      };

      sonucMesaji.textContent = 'İşlem gönderiliyor, lütfen bekleyin...';

      fetch("http://localhost:3000/api/gonder-imzali", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(islemVerisi),
      })
        .then(res => {
          if (!res.ok) return res.json().then(errorData => { throw new Error(errorData.hata); });
          return res.json();
        })
        .then(data => {
          sonucMesaji.textContent = "İşlem havuza eklendi.";
          aliciAdresInput.value = '';
          miktarInput.value = '';
          setTimeout(() => { sonucMesaji.textContent = ''; }, 4000);
        })
        .catch(error => {
          sonucMesaji.textContent = 'Hata: ' + error.message;
        });
    }
    function bekleyenIslemleriGuncelle() {
      const mempoolListesiDiv = document.getElementById("mempoolListesi");

      fetch(`http://localhost:3000/api/bekleyen-islemler`)
        .then(res => res.json())
        .then(islemler => {
          mempoolListesiDiv.innerHTML = ''; // Her güncellemede listeyi temizle
          if (islemler.length === 0) {
            mempoolListesiDiv.innerHTML = '<p style="text-align:center; color: #888;">Havuzda bekleyen işlem yok.</p>';
            return;
          }

          islemler.forEach(islem => {
            const islemP = document.createElement('p');
            islemP.style = "margin: 5px; padding: 5px; background: #fff; border-radius: 3px; border-left: 3px solid #ffa726;";
            islemP.textContent = `Gönderen: ${islem.sender_address.substring(0, 6)}... -> Alıcı: ${islem.receiver_address.substring(0, 6)}... | Miktar: ${islem.amount}`;
            mempoolListesiDiv.appendChild(islemP);
          });
        })
        .catch(err => {
          mempoolListesiDiv.innerHTML = '<p style="text-align:center; color: red;">Mempool yüklenemedi.</p>';
        });
    }
  </script>
</body>

</html>